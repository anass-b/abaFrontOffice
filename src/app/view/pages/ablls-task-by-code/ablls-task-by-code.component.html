<div class="ablls-wrapper container py-4">
  <!-- Header -->
  <div class="page-head">
    <div class="hgroup">
      <h1>ğŸ—‚ï¸ TÃ¢ches ABLLS par domaine</h1>
    </div>
  </div>

  <!-- Search / actions -->
  <section class="panel">
    <div class="controls">
      <div class="search">
        <span class="icon">ğŸ”</span>
        <input
          type="text"
          [(ngModel)]="search"
          placeholder="Rechercher par code ou titre (ex. B4, imitation)â€¦"
        />

        <!-- CatÃ©gories (domaines) -->
        <div class="chips">
          <button class="chip"
                  [class.active]="!selectedChip"
                  (click)="selectChip('')">Tous</button>
          <button class="chip"
                  *ngFor="let d of domainNames"
                  [class.active]="selectedChip===d"
                  (click)="selectChip(d)">
            {{ d }}
          </button>
        </div>
      </div>

      <div class="actions">
        <select class="sort-select" [(ngModel)]="sortMode" (ngModelChange)="applySort()">
          <option value="az">Tri : A-Z</option>
          <option value="za">Tri : Z-A</option>
          <option value="more">Tri : + de tÃ¢ches</option>
          <option value="less">Tri : - de tÃ¢ches</option>
        </select>

        <button class="btn ghost" (click)="resetAll()">â†» RÃ©initialiser</button>
        <button class="btn primary" *ngIf="auth.isAdmin" (click)="onAdd()">â• Ajouter un Domaine</button>
      </div>
    </div>
  </section>

  <!-- DOMAINES (cartes sombres) -->
  <section *ngIf="!selectedDomainName">
    <div class="domains-grid">
      <article class="domain-card"
               *ngFor="let domain of getFilteredDomains() | keyvalue : compareByPrefix"
               [hidden]="selectedChip && selectedChip !== domain.key">
        <div class="badge">{{ domainMap[domain.key]?.prefix ?? '?' }}</div>
        <div class="name">{{ domain.key }}</div>
        <div class="count">{{ domain.value.length }} tÃ¢che(s)</div>
        <div class="cta">
          <button class="btn primary" (click)="selectDomain(domain.key)">
            Voir les tÃ¢ches â†’
          </button>
        </div>
      </article>
    </div>
  </section>

  <!-- TÃ‚CHES (cartes claires) -->
  <section *ngIf="selectedDomainName">
    <div class="subhead">
      <h4>ğŸ“Œ TÃ¢ches pour le domaine : <strong>{{ selectedDomainName }}</strong></h4>
      <button class="btn ghost" (click)="clearDomain()">â† Retour</button>
    </div>

    <div class="tasks-grid">
      <article
        class="task-card"
        *ngFor="let task of getFilteredTasks(selectedDomainName)"
        (click)="goToDetail(task.id!)"
      >
        <div class="code">{{ task.code }}</div>
        <div class="title">{{ task.title }}</div>
        <div class="desc">
          {{ task.description || ('Domaine : ' + (task.domain?.name ?? 'Inconnu')) }}
        </div>

        <!-- chips dynamiques selon le modÃ¨le -->
        <div class="chips-compact">
          <span class="chip sm" *ngIf="task.domain?.name">{{ task.domain?.name }}</span>
          <span class="chip sm alt" *ngIf="task.reference">{{ task.reference }}</span>
          <span class="chip sm ok" *ngIf="task.status">{{ task.status }}</span>
        </div>

        <div class="cta-row" (click)="$event.stopPropagation()">
          <button class="btn cta" (click)="goToDetail(task.id!)">Voir la fiche â†’</button>
          <button class="btn outline"  (click)="viewBaseline(task.id)">Lignes de base</button>
        </div>
      </article>
    </div>

    <div *ngIf="getFilteredTasks(selectedDomainName).length === 0" class="empty-note">
      Aucun rÃ©sultat pour ce domaine avec cette recherche.
    </div>
  </section>
</div>
