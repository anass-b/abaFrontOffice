<div class="container py-4">
  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="p-4 border rounded bg-white shadow-sm">
    <h1 class="text-center">Ajouter une t√¢che ABLLS-R</h1>

    <label>Code de la t√¢che :</label>
    <input type="text" formControlName="code" placeholder="Ex : B3" class="form-control">

    <label class="mt-3">Domaine :</label>
    <select formControlName="domain" class="form-select">
      <option>Langage r√©ceptif</option>
      <option>Imitation</option>
      <option>Demande</option>
      <option>D√©nomination</option>
      <option>Intraverbal</option>
      <option>Motricit√© fine</option>
      <option>Jeu</option>
      <option>Autonomie</option>
    </select>

    <label class="mt-3">Nom de la t√¢che :</label>
    <input type="text" formControlName="title" placeholder="Ex : Associer des objets" class="form-control">

    <!-- üé• Vid√©o explicative -->
    <label class="mt-3">Vid√©o d‚Äôexplication g√©n√©rale</label>
    <select class="form-select" formControlName="explanationUseExternal" (change)="onExplanationTypeChange($event)">
      <option [ngValue]="true">Lien externe</option>
      <option [ngValue]="false">Fichier local</option>
    </select>

    <ng-container *ngIf="taskForm.get('explanationUseExternal')?.value">
      <input type="url" formControlName="explanationVideoUrl" class="form-control mt-2" placeholder="https://...">
    </ng-container>

    <ng-container *ngIf="!taskForm.get('explanationUseExternal')?.value">
      <input type="file" class="form-control mt-2" (change)="onExplanationVideoFileSelected($event)">
    </ng-container>

    <!-- üìå Nombre de crit√®res -->
    <label class="mt-3">Nombre de crit√®res :</label>
    <select class="form-select" [value]="nbCriteres" (change)="onCriteriaCountChange($event)">

      <option [value]="2">2</option>
      <option [value]="3">3</option>
      <option [value]="4">4</option>
    </select>

    <!-- üìã Crit√®res -->
    <!-- üìã Crit√®res enrichis -->
<div formArrayName="evaluationCriterias" *ngFor="let crit of evaluationCriterias.controls; let i = index">
  <div [formGroupName]="i" class="border rounded p-3 my-3">
    <h5>Crit√®re {{ i + 1 }}</h5>

    <label>Nom du crit√®re (label) :</label>
    <input type="text" formControlName="label" class="form-control mb-2" placeholder="Ex : Associer formes">

    <label>Type de vid√©o :</label>
<select class="form-select mb-2" [formControlName]="'useExternalDemonstrationVideo'" (change)="onCriteriaVideoTypeChange($event, i)">
  <option [ngValue]="true">Lien externe</option>
  <option [ngValue]="false">Fichier local</option>
</select>

<!-- Champ URL si externe -->
<ng-container *ngIf="evaluationCriterias.at(i).get('useExternalDemonstrationVideo')?.value">
  <label>Vid√©o d√©monstration (URL) :</label>
  <input type="url" formControlName="demonstrationVideoUrl" class="form-control mb-2" placeholder="https://...">
</ng-container>

<!-- Champ Fichier si local -->
<ng-container *ngIf="!evaluationCriterias.at(i).get('useExternalDemonstrationVideo')?.value">
  <label>Vid√©o d√©monstration (fichier) :</label>
  <input type="file" class="form-control mb-2" (change)="onDemonstrationVideoFileSelected($event, i)">
</ng-container>


    <label>Consigne :</label>
<textarea formControlName="consigne" class="form-control mb-2" placeholder="D√©crivez la consigne..."></textarea>

<label>R√©ponse attendue :</label>
<select formControlName="expectedResponse" class="form-select mb-2">
  <option>Pointage</option>
  <option>Don</option>
  <option>Verbalisation</option>
  <option>Imitation</option>
</select>


    <label>Type de guidance :</label>
    <select formControlName="guidanceType" class="form-select mb-2">
      <option>Aucune</option>
      <option>Verbale</option>
      <option>Gestuelle</option>
      <option>Physique partielle</option>
      <option>Physique totale</option>
    </select>

    <label>Taux de r√©ussite attendu (%) :</label>
    <input type="number" formControlName="successRate" class="form-control mb-3" min="0" max="100">

    <label class="mt-3">Mat√©riel associ√© :</label>
    
        <div *ngIf="materialList.length > 0; else loadingMaterials">
  <div *ngFor="let material of materialList" class="form-check d-flex align-items-center mb-2">
    <input
      class="form-check-input me-2"
      type="checkbox"
      [value]="material.id"
      (change)="onMaterialToggle($event, i)"
      [id]="'material_' + i + '_' + material.id"
    />

    <label class="form-check-label me-3" [for]="'material_' + i + '_' + material.id">
      {{ material.name }}
    </label>

    <!-- ‚úÖ Affichage image si disponible -->
    <img
      *ngIf="material.fileUrl"
      [src]="baseUrl + material.fileUrl"
      [alt]="material.name"
      class="img-thumbnail"
      style="max-height: 60px; max-width: 100px;"
    />
  </div>
</div>
<ng-template #loadingMaterials>
  <p class="text-muted">Chargement du mat√©riel en cours...</p>
</ng-template>

   
  </div>
</div>




    <!-- üìù Observations -->
    <label class="mt-3">Observations :</label>
    <textarea formControlName="description" rows="3" class="form-control"></textarea>

    <!-- üì§ Submit -->
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-success">Ajouter la t√¢che</button>
    </div>
  </form>
</div>
